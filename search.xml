<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>删除网卡自动分配的fix ip</title>
    <url>/2023/05/24/1/</url>
    <content><![CDATA[<p>当我们想要给云主机添加第二块无 IP 的网卡时，需要云主机挂载上新的网卡接口，但是在挂载接口时，时常会dhcp自动的分配一个ip地址，此时我们需要给他删除掉分配的地址，让他成为一个没有IP地址的网卡</p>
<p>找出目标云主机的 port 列表（此处我需要移除 IP的是 192.168.2.6 ）</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">openstack port list --server  1317ada5-231c-417f-9cc8-b6867591457e<br></code></pre></td></tr></table></figure>

<p><img src="/2023/05/24/1/1.jpg"></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">openstack  server  remove port $server_id  $port_id<br>openstack port set $port_id   --no-fixed-ip<br>openstack  server  add port $server_id  $port_id<br>openstack port list --server  41350a43-bd76-45fc-92ff-283e01c124fa<br></code></pre></td></tr></table></figure>

<p><img src="/2023/05/24/1/2.jpg"></p>
]]></content>
      <categories>
        <category>openstack</category>
      </categories>
  </entry>
  <entry>
    <title>Neutron-l3-agent</title>
    <url>/2023/05/24/Neutron-l3-agent/</url>
    <content><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="抱歉, 这个密码对哈, 请再试试或者联系管理员" data-whm="OOPS, these decrypted content may changed, but you can still have a look.">
  <script id="hbeData" type="hbeData" data-hmacdigest="ea5ef6321699a65adba3996c479a070526580ad172bd54904815c1a83a0f3d3d">0c8c0c54bff21ef7c09c278b65b38916110539cc29f84561de09453ca48d8dda922a237452f89f95847e475f7bf42f9b6a70d0d77c5728520b30bc255dc9517b3ac7a886a390cebec63c1e1a3398167dceea5c851a5651c58b7c9a21dbd32797ea3c9a1f95c5640c82c2ac3a8b88e09d623c6a4e8684094677ada9b41797c2bdfd0c46d27650e444779330bf56fa1f1c28f24971825453e45907268d192fcadd86b2faf02b85a628a3351e42e7d7db1246ac5dc576de1f16e73f6576e6ad9e529596ce9e713803c275e023bac079e0703dfd06a3f0a6a2cb35caaf229f1575aa0dace5106daca75104833f398f486c448a9db969b6021284bd5be03b90dd9c7e9ec332ff98801d308182a356e9a66657aae41a9ddf0cbdd380d29e02e3e3054f5d9fc2e9ea1b41c090e38a09aa6f4dbc3570d5134fccca831098e57c5d4a421e10853a67f769314f6c024df43e8f38e0a479c03769759a064a3bffe02650a4407b5ff6bf56fcd28228b0cf67ee1eac1e5befc2377b28f3b61b69d5c3db77b872b6fca87258c30290f4414408b3e5af5f666cc87cf6a8f2afa7023e7d4c6edad50dd92e4024d35deb2c680f3c1f8f7c5e9ef3153c626713af55c549c5e46ccf2efde7410d83e4305ff6a7a1bf175b891552c8b6c946ddf5c46944952d19e5a5f8301ba39324aff4f4fa638d6ed60126b32c21f5432eb739d123d72fa97f697727e104ae13054a6babaa341c15da8c0e4a545d9b850e0b8be91433f35ed16b464ac5f9b13a60e84c3f874d2c010ff2e9d5360dac5590d2585527af27a0a0354db38612f842a8ecb3f8edcce5716e5842aa71b81b35cafed1e30d00d3eb48a379bd677b55d6baee72687d39c6e5b053ddae6b89a7ce709b1aa109612cf70b636333fa63e4ecaf206b0066d86b2f9085c22abab4b231a35a890579c87061edf5105c16a38d9353384459274bc8d53698c7c355e2be2f342c358c452fa523b2e7e839948834a49b846c02beb78448315e0e4a2b94c25888c92a7b1a4765d8d899a162288cc76eccc1a81fd7311c477a168428f24826006aca23b3b06ad8e47fab2ced1db60aa6ae59e888d48180ba4a0238c141ae8a89aacf9b60bea9c8eaf7fa347667d885eb833304e087c34592a23d6a833c6ec02a28eb8f3ca6ef5a876e9b5d19617eb391bc861d9b24327905a471c62ec941f0c8feeb49a1607c83e39ab2fa4e7a20d59455a6b55ef22c4c6c98d4102842129ed9641ab894aa8ca9f60bc6656de3c2fd45398541fd47b45f037015c8bf498af19cb46f6f9cb760f11623799b67ec72d89ac34c4a6342906bd4703733d64ea7a3fbd5525283b0ed1182790dc57c310d40ef19b969a25b220779538b8b4d05471f39d0a57dfd78cfd9ef5d67ffebb20e7341b48df0c9530a82c790adb708e8491479f2918c35ebd2845c9f16ed766f6b6896a31a71554fb04abbf459ff62503bfabcc5b3e7b272641a9f9de70d22b44b1eacb1e7867fe322c7ef3f6769f1c201bdd655f4540ce95bdea72674ce1cd8bc667d36010d2a0119d9f00f54d42183467c03cdecc83b1532349c210a0ea3a091f0a52bf172367427e2215f0ed1abfc5cf40b6db916ca1aab76e0984f4dc1a9e8df5c6837f3f294582f391e2bf30d42af937625c3d235aa0fd46fffb1f7c7c75ced197f78136443ba0486f01b2b92fe6831c0d75dfea869c7a9c005ff7fef481ed588891c54c4b0bdb3e6ab48b4d8c013bce985f79190173ccec69c5896f66a5f34bb8eae41ade7feeb06c0af6d88dc8eabe1a81e632d0e033f5a831237be1029b74dd0228ad388e46a3ec58b4e1f51b1e9cc0bccd8c9fc1301012453d726c3bc36d3ae88d98ba64e1a1b59e5240af9347c3741ad3ab1cb94f3af23a32d5c7da81bf342a0ffc43f6d7681d2ceb53250e284e32fcb87aa5645b05750054bdd545d0df5278eed477c6d36605071951fcb3aa494434d788c8e488e67a59dd28d7141094fa39da3e35560b1632d55e4497108c360a954bf6de5601b821d8aff06beb846b4dad2de30a9fb43cb9225f392947a6e6c4b87fdc11337c975e6f898ab80c221ecf84c82d217b191f08080f94712a37748b3b28eeba92adf059537ff2ec32c85fb5b1e67e565a6c922b40eb681c211f57435120a62e890eccc8c9c689576ad8407692a799c37c17b42a28241c2de705f5978eeff073f1587bf06e6bd69ea3be00a2025d8557afc1362c821e73a2c2e9abb3518661104106d3d3206d352b3ef8b057ae3072f6bc885208161edfac345d5784f8aca9cd813e41c7a5e645ed064218993fc17e666d1350d2cfb090c902feffa47a2baf8f2bf521c299a782a8e4a8fe8e958fbd2033572adeda2c5b518bc4b4009010637bca565d66bab0d88cdecaa344d9adc6597efbb896559127d32c0088cde66d1b2a6e1530bae8917e7b805bd8b114d39299106c45ab4111495bb59b8447abf0c28425bf89136edc5eeac1b1e61fd06bb32b8deeb4cc3c141bd3d16fcb2f36255aa036616e59d9d2d438ce9d824bd07f96282b3f84866210e02e4ffd75c05b17cb047440d2efaa27296ff724e92a38bded96bd04304326d4c112c899438f6c9c1f659be7bd14d378081d3d430a20f94f1b44be2264212414dc1dbe1c233e607adc1898a2765d2a5b22a7fccfcbae3a01174c6194062b036cb60f2413f398c09a871d6e990d5178baa0e5dcb58030b3821256dd38191bca1df02604c7139ac0d0da201e7ff7ff552472163f91bb4b204fffb3f5d3aa5fc16c751a32a895975ef5fe575b53d9ac9300ad9d58f9f5fe195ec2dde5ff293802aca5ed292bd3ac27baca0bf9c0e68885ed6439e27e9c7de0c5f8706282c9a46759aeed68670da37e2e242bdcde4ea1fad78d13f5a612014d453ba22a46d8cc9ec3469a3b5744e45504c83db3eee3f9b8d5a4e529fb2d73bf48df3b6d3909280054c94b9dd10deb5008e18be89116ac5078fca6e22d552494b29611ee77b8758a13459c831e0e871fc728aaa6fa77f44161fe72d88d41a6532c0e5b316de375b76edcfaf614bf4d028c26c49f59add7fc4a91ca47e8218fc162eca411a75ba127cfc137a4173012877760576e100b8b7dd0d0a43d555ab8ccbc0ffccda0a008a812c61c6a7855b94544f122e46291eef39d850d090d976e8527f9a3e958ea79e3fb3d183b2d72191ee284f4ed49a90838a4f9e2f334fc85c580f5dcb44b89d8a01c813009409ed9f019d413188e97baec91acd2177642123c90e94419e0d0e14bab0ee840883d1a543dba9e9a9c4cd3765f8c07e04c0f92cfe904dff1495f0580fdabcfeb626478dadf2c1f1b88b618b7bc9c2292345820b05edab9e1ce6e17ba245b4e85548b162104216dfc88fe6d9896814cc41a10991ca823ce26f3cec31fff20a96e9362a5a3e69dd304e037899fd665b9abf86b70b013ca15a2634aa332db45e78298cc9d63a222cb32cdd80db9d8ff47220e50110b6506df41e1c0683f7163c78ff02ac5f04b94f27545dd38f13d25a5e532e3a197043504824101116f4772018e77b5c83da4d4176290a0e913036fcb701b557c08289a63a0c3a54390387b538abb80aa77eda8d3f60b4a47df2dadbb8b2288a54862fea1c5a9f7ddcc4f157bdbf1c9c0194d7b41d0de4512c08c1a552f002dd020fb7ad83831eaa28a800cbc3c111474321cac7a43d0410ecc2439dbd6d60552dcc88ab55d431bc3baa180e22ddd17b647ef3aeaf6aaffd27d0c6425691e56fe932ef6606a3779357cf9ad5273f230ed3f2b345df0f278518c53f7215ef2542442ac1baafe96a4fd1c2894877ecc114b0f8fdbb9383e2c70cae999ab3c4a5c1f9393d7b8a7bb34f7d26f9f2d603f31cb875ad7b56c44eca447c9aa392ab4a7f3ebd5346143b2443478d7d78f7153eaa2d0a371a912727daf64e494a4694611e46303fbab6affffbd2a748beab43620b9f62f1f2e088ef17e8ba36cf57903bf4fd8ed7403755bf3fdb2ada4e934adf8579ec6ada6bf8b10dd53184419569fafc421862a501cc726023acb1c23c4f30471901ea499e1fe7f7d3dcd6b88d5620b7fc2b5bd862ede18e4c803baee10cd6268d6b5290711b16460781972ee0558e97573ebfea5962a08c4710e6b3b06c20fe291f2fbb58c187885df2f405bc036510d4fac5699474b157836ee137a3038c778f2dad34a2ba81726d4a5558aae66c801257f147771ffe38002ea3f12c81379fa1b419a704e1d99a3320d8c22d7c9124672cf1f9ca35e0817b504f0a4d7d26d988c729aeda94cac6519126505d2a64e28f6e84e82e9df0bc8150b194eafdc9a5f39080e3715beffb337a357e0a8b1d6337a3a5e700144d67f7566b398d930ffe99a49a4ac3c7232a7255747d72ec0fecfabda4ea4459c8a30c276697b323de5ed6a90518c661a13269dc664b6d7a5816c922f4e010883df06677dad8999b552082ffa6e7d5d06cd332ddb3d4967f88da559c037c95edb3d5eeac293d0e3755e48c5f973be4d8f09b30e6e7d5c1ed00a6e7975dedef198da9afa95bba0be2bd8d947ceaaec35d038c749d1333858eb1d51edf042a94075a3388ab8bb86599d3172769bf1ded3eed3e3598c70d714428e83b87f7cda0ec591b9505b78b12abb4cb9de7c7ddbe4265852dfff9d77e2e923fde6788dd34ca596355a597bb6662ee21614342136b67993eb3cb94beb9b0e67ef11da4b4bf39dd9b2e87f0ca3c2c37dbf75cdc2517dc49408e2bc2a8ce7c9d74373d57ddc62264773d9a9e60ad4833698379fb1a44ce0508e79655438875e5004b666c10b1857d02f7dc324246c6e92e6520f7cfe8517ad47f2396c15c4f2b7137b2dac128af0f7765bd52d4d5d7f982c20fa8d8b3510aa94dd1f748411d8715fcb1ba195fa4674df25f0b5b8bef176deff4fc309c68ee779c34eb618ec0f202abb0766e0eeaa7226541e6b5d320a207b1b6ecb1bb269a6ec24524254332ddcb69ed141b374854e9d71afd6538ea7cce6acfbb449453da0831e0b041f6ff2ff255aff3a1eedcfe8baf997625ff60ed88279e0a84aa9c69998594c107bf04de44a3132e3b7c444e0d341c8827b54230f77aa1748adeec4ffb7b6866726ea7bd39c9680200abdcd8f8e2f9d34485e67fe76cd8f36ab7e66172d1c53f213a581b83e0ab47928bf2916136964609fcf5287894bf84b063bab4d253397395f73f4679d7980e125a76553cfdea45edff90d10004fb34f144f933815c531fa4d1773aa6fcb69e0fd9b3ee0a203a01323acaf236771e7802a18ff638b2a460f33a363c692c44ccc7e70af36631c846c68ca0030c30911d0fd61bf89febc0f9e8dfae6f234d212649749860336e7b730ab7d2f49dbbde62f79c198f506339bf180e82ea46556170b2d45269abbef8056d0f9fcb8a41ee269d1bbdc040d08eb493d35cf2a876a9421187a2ba45f629f8f27880dd55fe96c084c59f6cd1f8282fd9751205a8d3e3d690058337ed8a8abdf7421aae9e0be95a8630471e53c72c156acf8004fbf63fde98158770231ce085e6e9d1705531e0d31cc4ae86d176c07f337787977edaf232e742c0288cda25152c9de737d5102357f21c2d1043ed117ce7f2bec997fab8f8ab7d9e9f43c985b27b1be7e7b8b82ae28f74a3d96c25aac58a4a4dd84d9e664079f9ae79a430c3668c0a09093f5a0f187cb3f3af8a6100b0d09bbee716eebec568069990a9937366618b06b479f3dd076d8cd65e7fd099e766b700c336186ed11008d1cd14911fc7e9d7d17bd11467ad57ac8f6b9bffc022c33c94eca876c862e622acdcfc97119f7617aa7f93789fc32069e91a3e82547b0c1ca5356b1169adfef7cb066a2cfbd670f5ddf33de970f41becc3a0c72b7a25ec8b21109ed9613b6311a59d9e1f2c4ad83f666c71d9749662b415aa222e8c99dc6d6330f9a99c9704b6bdc5e4e5557885c94dce755b6ec0f97b7cbb11a4bf31f3acb17c85ce4bf19208cfdd3d397fecc29b34ca85b90d9aca2a88b6aad544e3b2b0be3076581bf09e0f850bb201a78b86dfc08bb4b123d8961a5ebc19426aff3dc7311d7256dda46d36f7e25086f988e3c6f759b104d2a81fd7e7f8dd410c5b8175c2789199a5db283f0bce95c8df658d86953966aa47b9e1868405139c60286ffadd8e5cb2bcad8167d3df762b4cb35cc3698b786ce3590ea40addd4ac8aa9e0bfd347262e8ba2b38803c62b783aeac711299e8b91572caec44ff51098853b4ede9005ef25c2a3e83e28fbf657e2be5f9fa9184f6cae8baf755d63ae39cf079e41e7b65b18dacf03c353966704e08abb561b597d7a7c510363400a9c65a5907be7d283bcb18753e896d955b1eabf9c150caa56c3cc58dc903fbfd1181b40dd4bb9f9e0332f38382c5f7f077454a9e6bd3863f70b3c08223e2c9b7021e70af744b08c28c4390bc17c29ca496180c4eccc29cc10dbd171225dd85e51fb514c1b2998744aa83dfc95f4ac5f40430b03c0c41b62b3c6528451824e10310c1097ea0ada13311a1228c654993be69ee39997a5fa79c9726dc01d166ecd3c39a5cfdbdae047356337d1cf2e20b16b1a8dd7b5a7c9313aaab15aeb6d0f9ddece98d735a8e2f3add640f08ccd8769c6e924f0457c7f1368a3a23254efeb70616d2085d541d58c033ab056677dda9e3f1c418a8a4c94a70e115c3741e4745d2820a6584f00ad76020561dad046abaf334d1215881ccb0b209b0e7aedb7653abedc01fb7249b9f712f3a46e968a6c0de6b52d5662d2434929c01b35582ef70e6227150a39c7dd69512b6a8fa94ae3ed3f9235a28c417f2954e21bc0c3fc0310e918c8d7c208d9043dd54971d6f9ecc645562aab6671e59ec1d5f3e4ae25eca93b3966e8a29d6196a8638463860a2a242d0f144675f2cd3ebf33d1ed79ee1225a8e94b466a329cc21ab964040fb8f0d90ac2dae44501f7f59426479da823281bda6adf8b9568607d69c52cfb68500133a882bb5d5be41ea3d0e109eb9e4b5ecc51c06a540eec0baa08d88b7c80da803cea63ea1231475f5b7a92f6a144a0df8882038ace61c50e152e1bbd2782931621e694dba6c073bfc6c2fb0b1f8a91f2ed38739449150f7e029f5a1bd8db1752304a4def1dc01d4e66da91888c332ddf2caa23db7fd8bb731f94e558ed507e0d2792f0ce26e857274621e5acea2b4eba18316da6b41f905b65d9fe7bfe8434517b5af63de990ecc1e03437e6958e4b7d3ce3bcd7ae63b7bc66d618b5401702756cbf88a0148e1ce8ff2160c645e09fd4da58e3a079278bb381eb52091757631354e3266d8690960aea4a6a42e19949c0845e0417bc19fe9527dbaa92bd8cbaaf9afc0a235643f95a434ae438e148f16847dbe64a13e13357db17794550de1427711e14ef249e53eba0c56798ac69534464d79571be55a0d7b6c4c0a86d6e3f425f6cb89e67704362fdc910a31a172464ea0a025c28a66cc647580be09d18f9aca17fe17438eca0bbc17e39f857d29618d1d63b1230fc2b411d450bc79088301b8a1e59eec0dde050855dccec5fbd8cda7302ba3ba10c8c2356d743da7d59bc21cd3b21b1128f25c2eae1b5bb27ca45bd0eb09787419ee4c7dd7f36eb034a7bbb96bff59217f861b559c8d6da3c05cd62ddfc4eb54fe0d7bb9431bfacf3c36b70704e6c5fae986f3e611bf78d85e953a16555ea07892528aaf86a8fbc0f01bacf7769180be3c91f6666d7051ddb4557bfb095e8dc330c8226d9fbd29e0f02324b9ea030e272c8d9619fc71aa7e94f6f854ef8e79065a888fd11b81e84401a6c31d73a007d746d5ea95bb12619bb4c6c13e42736b19ab89f38da5ff063a69b3fca12c04689b59d2d0e97243d58bc16bcc778ac33da428c57e7a295ebcfd9f5f01c348e58bd3594c71501147091254de88410ab57e52acda53d74d05759b588413a4fc4c70fb66c508c02c86ba97439e30fd66e6790bb6028c4c580d06aa00fd4d4a59f2a9313667f52d025d865ae4966800899bb16e4e0cc4a2d202b79b9ab809001f664707196479fe7d1f2eb2c10c584a9ed9377cf495f8c1536c8c5aba7fc85b9c992ed3b53a4f7750efd02e05bc96f577eeec85c9503747f5306dae0c3a8d31be61fecc7fe69b3d97bedf37eb40fbc636877e0b5cba1</script>
  <div class="hbe hbe-content">
    <div class="hbe hbe-input hbe-input-default">
      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">
      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">
        <span class="hbe hbe-input-label-content hbe-input-label-content-default">请输入文章查看密码</span>
      </label>
    </div>
  </div>
</div>
<script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      <categories>
        <category>openstack</category>
      </categories>
      <tags>
        <tag>openstack</tag>
        <tag>private</tag>
      </tags>
  </entry>
  <entry>
    <title>OpenStack Neutron trunk ports</title>
    <url>/2023/05/28/Neutron-trunk%20ports/</url>
    <content><![CDATA[<p>​     OpenStack Neutron trunk ports （VLAN-aware-VMs）,”VLAN aware VMs”有时也叫做”VM trunk ports”, 主要是让虚拟机收发的vlan tagged报文, 能够被虚拟网络所识别和处理。</p>
<p>什么是主机的Trunk port？一般来说VLAN只是对交换机可知，主机不感知VLAN，也就是主机网卡发送出来的数据是不带VLAN Tag的。当主机将网卡配置成Trunk port，会在主机的Trunk port上添加多个带有不同VLAN ID的子网卡。通过子网卡发送的数据，会打上VLAN Tag，被发送出去。由于主机发送的网络数据有了变化（带上了VLAN Tag），对主机连接的网络提出了新的要求。另一方面，由于带了不同的VLAN Tag，子网卡可以认为连接在VLAN Tag标识的网络中。这样，不用实际增减主机的网卡，只需要为主机创建带VLAN ID的子网卡，就可以将主机添加到新的VLAN网络中。</p>
<p>​     OpenStack对VLAN Trunk的支持就是指对OpenStack所管理的虚机的Trunk port，提供网络支持。大多数场景下，主机收发的是不带tag的报文，但是在实际环境中，无论是windows还是Linux环境都通过各自的方法可以收发带有vlan tag的报文。 而一个虚机要想接收不同vlan tag的报文，就需要在虚机上接入不同网络，即在虚机上配置不同网络的虚拟网卡。在NFV（Network Function Virtualization）场景下，若网络数量巨大，网卡数量也巨大，这种实现的方法就不现实；另一方面，连接的多个网络也是动态增减的，如果每次都增减网卡明显也是不方便的。如果使用Trunk port，当需要动态连接多个网络时，只需要动态的创建/删除相应的子网卡即可</p>
<p>​      OpenStack中虚机的 Trunk port 设置步骤如下：</p>
<ul>
<li>需要在网络节点的neutron.conf里配置service_plugins为: “trunk”</li>
<li>创建网络，如 net0(parent-net), net1,net2等，租户需要几个vlan网络，就需要创建几个对应net</li>
<li>创建 parentport 端口，一个vm对应一个parentport</li>
<li>创建 trunk，每一个trunk实例中包含一个parentport, 和若干个其他子接口netport</li>
<li>创建 vm，指定parentport；在vm内创建子接口接口，并获取 dhcp 地址</li>
</ul>
]]></content>
      <categories>
        <category>openstack</category>
      </categories>
  </entry>
  <entry>
    <title>kolla-ansible 部署报错</title>
    <url>/2023/05/24/kolla-ansible-issue/</url>
    <content><![CDATA[<h2 id="问题现象："><a href="#问题现象：" class="headerlink" title="问题现象："></a>问题现象：</h2><p>环境：系统 centos7，通过 kolla-ansible 部署 train 版 Openstack，在 deploy 部署阶段执行到任务 </p>
<p>TASK [service-rabbitmq : nova | Ensure RabbitMQ users exist] 报错 FAILED - RETRYING: nova | Ensure RabbitMQ users exist (5 retries left). 详情如下图：</p>
<p><img src="/2023/05/24/kolla-ansible-issue/1.png"></p>
<h2 id="问题分析："><a href="#问题分析：" class="headerlink" title="问题分析："></a>问题分析：</h2><p>查询相关博客给出的解决办法是清理部署环境，重新部署。但我清理多次部署还是会报错如上图。</p>
<p>后谷歌相关资料，发现很多人部署都出现过这个问题，其实是 kolla-ansible 的一个bug，需要修改一下配置文件。并且This issue was fixed in the openstack/kolla-ansible 14.0.0.0rc1 release candidate.</p>
<p><a href="https://bugs.launchpad.net/kolla-ansible/+bug/1946506">原文链接</a></p>
<h2 id="解决办法："><a href="#解决办法：" class="headerlink" title="解决办法："></a>解决办法：</h2><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">vi /usr/share/kolla-ansible/ansible/roles/service-rabbitmq/tasks/main.yml <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">在第 21 行 添加如下代码</span><br><br>node: &quot;rabbit@&#123;&#123; ansible_facts.hostname &#125;&#125;&quot;<br></code></pre></td></tr></table></figure>

<p>如图：</p>
<p><img src="/2023/05/24/kolla-ansible-issue/2.jpeg"></p>
<p>此时再去执行 deploy，安装成功 </p>
]]></content>
      <categories>
        <category>openstack</category>
      </categories>
  </entry>
  <entry>
    <title>openstack常用命令整理</title>
    <url>/2023/05/24/openstack/</url>
    <content><![CDATA[<h2 id="配额-「quota」"><a href="#配额-「quota」" class="headerlink" title="配额 「quota」"></a>配额 「quota」</h2><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">openstack quota set --ram 1024 --instances 5 --cores 3 &#123;项目名&#125;     # 项目限制配额<br></code></pre></td></tr></table></figure>

<h2 id="虚拟机-「server」"><a href="#虚拟机-「server」" class="headerlink" title="虚拟机 「server」"></a>虚拟机 「server」</h2><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">openstack console url show &#123;虚拟机名字&#125;<br>openstack server delete &#123;虚拟机名字&#125;<br>openstack server force-delete &#123;虚拟机名字&#125;       # 强制删除虚机<br>openstack server list / show  <br>openstack server resize      # 调整云主机大小<br>openstack server event list --long &#123;虚拟机 id&#125;    # 查询云主机的事件<br></code></pre></td></tr></table></figure>

<h2 id="搁置-「shelve」"><a href="#搁置-「shelve」" class="headerlink" title="搁置 「shelve」"></a>搁置 「shelve」</h2><p>对于一些长时间不使用的虚拟机，即使处于关机状态，仍然会占用着集群资源<br>如果需要释放这些资源,则使用shelve来操作,该操作会将server实例作为image保存到glance中,然后在宿主机中删除该server实例</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">openstack server shelve &#123;虚机id&#125;  # 机器开启搁置状态 （搁置状态：--status SHELVED_OFFLOADED ）<br>openstack server unshelve     # 取消搁置的机器<br></code></pre></td></tr></table></figure>

<h2 id="镜像-「image」"><a href="#镜像-「image」" class="headerlink" title="镜像 「image」"></a>镜像 「image」</h2><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">共享私有镜像给其他项目<br><br>openstack image set --shared &#123;镜像id&#125;    # 镜像设置为共享<br>openstack image add project  &#123;镜像id&#125;  &#123;目标项目id&#125; <br>openstack role add --user &#123;&#125;  project_member --project  &#123;目标项目id&#125; <br><br>export OS_PROJECT_NAME=&#123;目标项目名&#125;       # 切换项目<br>openstack image set --accept &#123;目标镜像id&#125; <br>export OS_PROJECT_NAME=&#123;&#125;<br>openstack role remove --user &#123;&#125; project_member --project &#123;目标项目id&#125;<br><br>openstack image member list &#123;目标镜像id&#125;     # 验证是否共享成功<br><br>openstack image set  # 更新镜像<br></code></pre></td></tr></table></figure>



<h2 id="网络-「network」"><a href="#网络-「network」" class="headerlink" title="网络 「network」"></a>网络 「network」</h2><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">openstack floating ip list <br><br>云主机添加无IP的网卡<br>openstack network list --project &#123;项目名&#125;    # 查看项目下网络<br><br>openstack port create  --network  &#123;网络id/name&#125;   &#123;端口名&#125;     在不指定IP地址的情况下创建一个端口<br><br>创建指定IP地址的端口<br>openstack port create --network net1 --fixed-ip subnet=subnet1,ip-address=192.0.2.40 &#123;端口名&#125;  <br><br>openstack port list <br>nova interface-attach --port-id  &#123;port id&#125;   &#123;server id&#125;   <br></code></pre></td></tr></table></figure>



<h2 id="支付者-「assignment」"><a href="#支付者-「assignment」" class="headerlink" title="支付者 「assignment」"></a>支付者 「assignment」</h2><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">openstack role assignment list  --project  &#123;项目名&#125;  --name  # 查看用户的支付者<br></code></pre></td></tr></table></figure>



<h2 id="卷-「volume」"><a href="#卷-「volume」" class="headerlink" title="卷  「volume」"></a>卷  「volume」</h2><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">openstack volume type list   # 查看卷类型<br>openstack volume set --state &#123;&#125;     # 改变云硬盘状态  <br>openstack volume backup list   # 查看云硬盘备份<br>openstack volume snapshot list --all --volume &#123; id/name &#125;<br><br>nova  volume-detach  &#123;云主机ID&#125; &#123;volume id&#125;     # 分离卷<br></code></pre></td></tr></table></figure>

<p>Volume 除了可以用作 instance 的数据盘，也可以作为启动盘（Bootable Volume）创建Volume时，选择Volume Source为image，创建后可以看到该volume是Bootable的，后可根据需求创建可启动volume</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">openstack volume create --image $IMAGE_ID --size $SIZE --type $TYPE --bootable $NAME<br></code></pre></td></tr></table></figure>



<h2 id="迁移-「migrate」"><a href="#迁移-「migrate」" class="headerlink" title="迁移  「migrate」"></a>迁移  「migrate」</h2><p>迁移的云主机若内存等资源使用率过高会导致热迁移实例写入内存页面的速度可能比复制它们的速度快<br>从而虚拟机产生了内存脏数据,无法完成迁移超时,虚拟机状态error</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">nova live-migration-force-complete 实例ID 迁移ID        # 强制迁移<br>nova server-migration-list 实例ID                  # 获取迁移的任务ID<br>nova live-migration-abort 实例ID 迁移ID                 # 取消迁移<br></code></pre></td></tr></table></figure>



<h2 id="负载均衡-「loadbalancer」"><a href="#负载均衡-「loadbalancer」" class="headerlink" title="负载均衡  「loadbalancer」"></a>负载均衡  「loadbalancer」</h2><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">openstack loadbalancer list<br></code></pre></td></tr></table></figure>





<p><a href="https://access.redhat.com/documentation/zh-cn/red_hat_openstack_platform/17.0/html/command_line_interface_reference/index">redhat官方openstack命令行文档</a></p>
]]></content>
      <categories>
        <category>openstack</category>
      </categories>
  </entry>
  <entry>
    <title>kolla-ansible 部署 openstack——train</title>
    <url>/2023/05/24/kolla-ansible-deploy-openstack-train/</url>
    <content><![CDATA[<h1 id="环境介绍"><a href="#环境介绍" class="headerlink" title="环境介绍"></a>环境介绍</h1><p>系统：centos7<br>三台云主机</p>
<h1 id="节点规划"><a href="#节点规划" class="headerlink" title="节点规划"></a>节点规划</h1><table>
<thead>
<tr>
<th>主机名</th>
<th>ip 地址</th>
<th>角色</th>
<th>内存/CPU</th>
<th>网卡—eth0</th>
<th>网卡—eth1</th>
</tr>
</thead>
<tbody><tr>
<td>controller</td>
<td>192.168.100.11</td>
<td>控制节点</td>
<td>8G/2核</td>
<td>192.168.100.11</td>
<td>none</td>
</tr>
<tr>
<td>compute</td>
<td>192.168.100.9</td>
<td>计算节点</td>
<td>8G/2核</td>
<td>192.168.100.9</td>
<td>none</td>
</tr>
<tr>
<td>storage</td>
<td>192.168.100.4</td>
<td>存储节点</td>
<td>8G/2核</td>
<td>192.168.100.4</td>
<td>none</td>
</tr>
</tbody></table>
<h1 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h1><h2 id="一-、基础环境准备："><a href="#一-、基础环境准备：" class="headerlink" title="(一)、基础环境准备："></a>(一)、基础环境准备：</h2><p><strong>++ 所有节点操作================</strong></p>
<h3 id="1、-修改主机名-amp-配置主机映射"><a href="#1、-修改主机名-amp-配置主机映射" class="headerlink" title="1、 修改主机名&amp;配置主机映射"></a>1、 修改主机名&amp;配置主机映射</h3><h3 id="2、-关闭-防火墙-amp-selinux"><a href="#2、-关闭-防火墙-amp-selinux" class="headerlink" title="2、 关闭 防火墙&amp;selinux"></a>2、 关闭 防火墙&amp;selinux</h3><h3 id="3、-ssh-免密配置"><a href="#3、-ssh-免密配置" class="headerlink" title="3、 ssh 免密配置"></a>3、 ssh 免密配置</h3><blockquote>
<p>部署节点和其他节点免密登陆</p>
</blockquote>
<h3 id="4、-安装配置-docker"><a href="#4、-安装配置-docker" class="headerlink" title="4、 安装配置 docker"></a>4、 安装配置 docker</h3><blockquote>
<p>开启 Docker 的共享挂载功能：所谓共享挂载即同一个目录或设备可以挂载到多个不同的路径并且能够保持互相之间的共享可见性，类似于 mount –shared。在 OpenStack for Kolla 中，主要解决 Neutron 的 namespace 在不同 container 中得以保持实效性的问题。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">安装 docker</span><br>yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo<br>yum install -y docker-ce<br>systemctl enable docker &amp;&amp; systemctl start docker<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">设置 Docker 的镜像源</span><br>mkdir -p /etc/docker<br>vim /etc/docker/daemon.json <br>&#123; <br>&quot;registry-mirrors&quot;: [&quot;https://docker.mirrors.ustc.edu.cn&quot;] <br>&#125;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">设置 Docker 挂载卷的方式为 Share</span><br>mkdir -p /etc/systemd/system/docker.service.d<br>cat /etc/systemd/system/docker.service.d/kolla.conf <br>[Service] <br>MountFlags=shared<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">重启 docker</span><br>systemctl daemon-reload &amp;&amp; systemctl restart docker<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看 docker 信息</span><br>docker info<br><br></code></pre></td></tr></table></figure>
<h3 id="5、-设置-pip-下载源"><a href="#5、-设置-pip-下载源" class="headerlink" title="5、 设置 pip 下载源"></a>5、 设置 pip 下载源</h3><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">mkdir .pip<br>cat &gt; .pip/pip.conf &lt;&lt; EOF<br>[global]<br>index-url=http://mirrors.aliyun.com/pypi/simple/<br>[install]<br>trusted-host=mirrors.aliyun.com<br>EOF<br><br></code></pre></td></tr></table></figure>

<h3 id="6、-安装-pip"><a href="#6、-安装-pip" class="headerlink" title="6、  安装 pip"></a>6、  安装 pip</h3><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">安装 pip</span><br><br>curl https://bootstrap.pypa.io/pip/2.7/get-pip.py -o get-pip27.py<br>python get-pip27.py<br><br></code></pre></td></tr></table></figure>

<p><strong>++ controller 节点操作================</strong></p>
<h3 id="7、-安装-ansible-kolla-ansible"><a href="#7、-安装-ansible-kolla-ansible" class="headerlink" title="7、  安装 ansible/kolla-ansible"></a>7、  <strong>安装 ansible/kolla-ansible</strong></h3><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">安装 ansible</span><br>pip install ansible===2.9.0<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">安装 kolla-anisble</span><br>pip install pbr<br>pip install kolla-ansible --ignore-installed requests<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"> 根据报错可选安装</span><br>pip install setuptools-scm<br>pip install -U setuptools<br>pip install kolla-ansible --ignore-installed PyYAML<br><br></code></pre></td></tr></table></figure>

<h3 id="8、-安装配置-python-虚拟环境"><a href="#8、-安装配置-python-虚拟环境" class="headerlink" title="8、  安装配置 python 虚拟环境"></a>8、  <strong>安装配置 python 虚拟环境</strong></h3><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">安装 Python virtualenv 相关依赖</span><br>yum -y install python-virtualenv  <br>mkdir /opt/kolla<br>virtualenv /opt/kolla/<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">创建并激活一个 Python 虚拟环境</span><br>source /opt/kolla/bin/activate    <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">退出虚拟环境</span><br>deactivate<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">删除虚拟环境，只需删除对应的虚拟环境文件夹即可</span><br><br></code></pre></td></tr></table></figure>


<h2 id="（二）-配置-kolla-ansible："><a href="#（二）-配置-kolla-ansible：" class="headerlink" title="（二）  配置 kolla-ansible："></a>（二）  <strong>配置 kolla-ansible：</strong></h2><h3 id="1、-复制模版文件"><a href="#1、-复制模版文件" class="headerlink" title="1、  复制模版文件"></a>1、  <strong>复制模版文件</strong></h3><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">cp /usr/share/kolla-ansible/etc_examples/kolla/* /etc/kolla/<br>cp /usr/share/kolla-ansible/ansible/inventory/* /etc/kolla/<br></code></pre></td></tr></table></figure>

<h3 id="2、修改部署配置文件—globals-yml"><a href="#2、修改部署配置文件—globals-yml" class="headerlink" title="2、修改部署配置文件—globals.yml"></a>2、修改部署配置文件—globals.yml</h3><blockquote>
<p>可根据需要自行改</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">---<br>kolla_base_distro: &quot;centos&quot;<br>kolla_install_type: &quot;source&quot;<br>openstack_release: &quot;train&quot;<br>kolla_internal_vip_address: &quot;192.168.100.11&quot;<br>network_interface: &quot;eth0&quot;<br>neutron_external_interface: &quot;eth1&quot;<br>enable_haproxy: &quot;no&quot;<br>enable_cinder: &quot;no&quot;<br>nova_compute_virt_type: &quot;qemu&quot;<br></code></pre></td></tr></table></figure>

<h3 id="3、编辑文件—multinode"><a href="#3、编辑文件—multinode" class="headerlink" title="3、编辑文件—multinode"></a>3、编辑文件—multinode</h3><h3 id="4、配置密码文件—passwords-yml"><a href="#4、配置密码文件—passwords-yml" class="headerlink" title="4、配置密码文件—passwords.yml"></a>4、配置密码文件—passwords.yml</h3><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">生成密码至 passwords.yml</span><br>kolla-genpwd<br></code></pre></td></tr></table></figure>

<h2 id="（三）-部署-openstack-环境"><a href="#（三）-部署-openstack-环境" class="headerlink" title="（三） 部署 openstack 环境"></a>（三） 部署 openstack 环境</h2><h3 id="1、安装-openstack-云平台"><a href="#1、安装-openstack-云平台" class="headerlink" title="1、安装 openstack 云平台"></a>1、安装 openstack 云平台</h3><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">测试节点连通性</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">bootstrap-server安装 OpenStack 所需的依赖包</span><br>kolla-ansible -i multinode bootstrap-servers<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">检查配置</span><br>kolla-ansible prechecks  -i multinode <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">下载openstack各个组件容器镜像</span> <br>kolla-ansible pull -i /etc/kolla/multinode<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">-vvv: 此参数添加，可打印出详情</span><br>kolla-ansible -i multinode deploy <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">生成环境脚本</span><br>kolla-ansible post-deploy /etc/kolla/admin-openrc.sh<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">遇到报错，销毁已安装的环境</span><br>kolla-ansible  destroy  ./multinode    --yes-i-really-really-mean-it<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">调整配置及重新部署</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">编辑 globals.yml 后, 然后运行 reconfigure 使用 -t 参数可以只对变动的模块进行调整</span><br>kolla-ansible -i /etc/kolla/multinode reconfigure -t neutron<br>kolla-ansible -i /etc/kolla/multinode  deploy -t neutron<br><br></code></pre></td></tr></table></figure>

<h3 id="2、安装-openstack-客户端"><a href="#2、安装-openstack-客户端" class="headerlink" title="2、安装 openstack 客户端"></a>2、安装 openstack 客户端</h3><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">docker run -d --name client \<br>  --restart always \<br>  -v /etc/kolla/admin-openrc.sh:/admin-openrc.sh:ro \<br>  -v /usr/share/kolla-ansible/init-runonce:/init-runonce:rw \<br>  kolla/centos-binary-openstack-base:train sleep infinity<br> <br>docker exec -it client bash<br>source /admin-openrc.sh<br>openstack service list<br></code></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>openstack</category>
      </categories>
      <tags>
        <tag>openstack</tag>
        <tag>kolla</tag>
      </tags>
  </entry>
</search>
