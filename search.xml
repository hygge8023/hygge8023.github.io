<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>OpenStack Neutron trunk ports</title>
    <url>/2023/05/28/Neutron-trunk%20ports/</url>
    <content><![CDATA[<p>​     OpenStack Neutron trunk ports （VLAN-aware-VMs）,”VLAN aware VMs”有时也叫做”VM trunk ports”, 主要是让虚拟机收发的vlan tagged报文, 能够被虚拟网络所识别和处理。</p>
<p>什么是主机的Trunk port？一般来说VLAN只是对交换机可知，主机不感知VLAN，也就是主机网卡发送出来的数据是不带VLAN Tag的。当主机将网卡配置成Trunk port，会在主机的Trunk port上添加多个带有不同VLAN ID的子网卡。通过子网卡发送的数据，会打上VLAN Tag，被发送出去。由于主机发送的网络数据有了变化（带上了VLAN Tag），对主机连接的网络提出了新的要求。另一方面，由于带了不同的VLAN Tag，子网卡可以认为连接在VLAN Tag标识的网络中。这样，不用实际增减主机的网卡，只需要为主机创建带VLAN ID的子网卡，就可以将主机添加到新的VLAN网络中。</p>
<p>​     OpenStack对VLAN Trunk的支持就是指对OpenStack所管理的虚机的Trunk port，提供网络支持。大多数场景下，主机收发的是不带tag的报文，但是在实际环境中，无论是windows还是Linux环境都通过各自的方法可以收发带有vlan tag的报文。 而一个虚机要想接收不同vlan tag的报文，就需要在虚机上接入不同网络，即在虚机上配置不同网络的虚拟网卡。在NFV（Network Function Virtualization）场景下，若网络数量巨大，网卡数量也巨大，这种实现的方法就不现实；另一方面，连接的多个网络也是动态增减的，如果每次都增减网卡明显也是不方便的。如果使用Trunk port，当需要动态连接多个网络时，只需要动态的创建/删除相应的子网卡即可</p>
<p>​      OpenStack中虚机的 Trunk port 设置步骤如下：</p>
<ul>
<li>需要在网络节点的neutron.conf里配置service_plugins为: “trunk”</li>
<li>创建网络，如 net0(parent-net), net1,net2等，租户需要几个vlan网络，就需要创建几个对应net</li>
<li>创建 parentport 端口，一个vm对应一个parentport</li>
<li>创建 trunk，每一个trunk实例中包含一个parentport, 和若干个其他子接口netport</li>
<li>创建 vm，指定parentport；在vm内创建子接口接口，并获取 dhcp 地址</li>
</ul>
]]></content>
      <categories>
        <category>openstack</category>
      </categories>
  </entry>
  <entry>
    <title>kolla-ansible 部署报错</title>
    <url>/2023/05/24/kolla-ansible-issue/</url>
    <content><![CDATA[<h2 id="问题现象："><a href="#问题现象：" class="headerlink" title="问题现象："></a>问题现象：</h2><p>环境：系统 centos7，通过 kolla-ansible 部署 train 版 Openstack，在 deploy 部署阶段执行到任务 </p>
<p>TASK [service-rabbitmq : nova | Ensure RabbitMQ users exist] 报错 FAILED - RETRYING: nova | Ensure RabbitMQ users exist (5 retries left). 详情如下图：</p>
<p><img src="/2023/05/24/kolla-ansible-issue/1.png"></p>
<h2 id="问题分析："><a href="#问题分析：" class="headerlink" title="问题分析："></a>问题分析：</h2><p>查询相关博客给出的解决办法是清理部署环境，重新部署。但我清理多次部署还是会报错如上图。</p>
<p>后谷歌相关资料，发现很多人部署都出现过这个问题，其实是 kolla-ansible 的一个bug，需要修改一下配置文件。并且This issue was fixed in the openstack/kolla-ansible 14.0.0.0rc1 release candidate.</p>
<p><a href="https://bugs.launchpad.net/kolla-ansible/+bug/1946506">原文链接</a></p>
<h2 id="解决办法："><a href="#解决办法：" class="headerlink" title="解决办法："></a>解决办法：</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vi /usr/share/kolla-ansible/ansible/roles/service-rabbitmq/tasks/main.yml </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在第 21 行 添加如下代码</span></span><br><span class="line"></span><br><span class="line">node: &quot;rabbit@&#123;&#123; ansible_facts.hostname &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>

<p>如图：</p>
<p><img src="/2023/05/24/kolla-ansible-issue/2.jpeg"></p>
<p>此时再去执行 deploy，安装成功 </p>
]]></content>
      <categories>
        <category>openstack</category>
      </categories>
  </entry>
  <entry>
    <title>Neutron-l3-agent</title>
    <url>/2023/05/24/network/</url>
    <content><![CDATA[<p>Neutron 的路由服务是由 l3 agent 提供的。 除此之外，l3 agent 通过 iptables 提供 firewall 和 floating ip 服务</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">openstack network agent list --host B2U02NET04</span></span><br><span class="line">+--------------------------------------+--------------------+------------+-------------------+-------+-------+---------------------------+</span><br><span class="line">| ID                                   | Agent Type         | Host       | Availability Zone | Alive | State | Binary                    |</span><br><span class="line">+--------------------------------------+--------------------+------------+-------------------+-------+-------+---------------------------+</span><br><span class="line">| 178352d1-b827-402b-8ac8-f2529f8c0079 | Metadata agent     | B2U02NET04 | None              | :-)   | UP    | neutron-metadata-agent    |</span><br><span class="line">| 4ace5ae6-ce68-4dfb-85b9-7e1ca139c21f | DHCP agent         | B2U02NET04 | nova              | :-)   | UP    | neutron-dhcp-agent        |</span><br><span class="line">| 90a46a2a-80cf-400f-a5fd-a620155c0a4c | Open vSwitch agent | B2U02NET04 | None              | :-)   | UP    | neutron-openvswitch-agent |</span><br><span class="line">| fac20f42-457a-486f-92c8-1d3eb6f1c39e | L3 agent           | B2U02NET04 | nova              | :-)   | UP    | neutron-vpn-agent         |</span><br><span class="line">+--------------------------------------+--------------------+------------+-------------------+-------+-------+---------------------------+</span><br></pre></td></tr></table></figure>

<p>根据 路由id 可以找到本 router 所在的网络节点</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">openstack router list  --project wangpeipei</span></span><br><span class="line">+--------------------------------------+----------------+--------+-------+----------------------------------+-------------+------+</span><br><span class="line">| ID                                   | Name           | Status | State | Project                          | Distributed | HA   |</span><br><span class="line">+--------------------------------------+----------------+--------+-------+----------------------------------+-------------+------+</span><br><span class="line">| 2878b574-9793-45a5-bf39-04e1092fb697 | Default Router | ACTIVE | UP    | 8923b95c43414065a7dcfee1f4d6477b | False       | True |</span><br><span class="line">+--------------------------------------+----------------+--------+-------+----------------------------------+-------------+------+</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取该路由上的 业务 IP</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">openstack floating ip list --router 2878b574-9793-45a5-bf39-04e1092fb697</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">环境为高可用主备router节点，HA State 为 standby 表示待用状态</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">openstack network agent list --router 2878b574-9793-45a5-bf39-04e1092fb697 --long</span></span><br><span class="line">+--------------------------------------+------------+------------+-------------------+-------+-------+-------------------+----------+</span><br><span class="line">| ID                                   | Agent Type | Host       | Availability Zone | Alive | State | Binary            | HA State |</span><br><span class="line">+--------------------------------------+------------+------------+-------------------+-------+-------+-------------------+----------+</span><br><span class="line">| 8add8415-5956-462a-93d1-e9a97c7a3cbe | L3 agent   | A4U02NET02 | nova              | :-)   | UP    | neutron-vpn-agent | active   |</span><br><span class="line">| e123a05b-fe85-4207-b0aa-ff2a3a9169e4 | L3 agent   | B1U02NET03 | nova              | :-)   | UP    | neutron-vpn-agent | standby  |</span><br><span class="line">+--------------------------------------+------------+------------+-------------------+-------+-------+-------------------+----------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@A4U02NET02 ~]# ip netns ls  |grep  2878b574-9793-45a5-bf39-04e1092fb697</span><br><span class="line">qrouter-2878b574-9793-45a5-bf39-04e1092fb697 (id: 36)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



















]]></content>
      <categories>
        <category>openstack</category>
      </categories>
  </entry>
  <entry>
    <title>openstack常用命令整理</title>
    <url>/2023/05/24/openstack/</url>
    <content><![CDATA[<h2 id="配额-「quota」"><a href="#配额-「quota」" class="headerlink" title="配额 「quota」"></a>配额 「quota」</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">openstack quota set --ram 1024 --instances 5 --cores 3 &#123;项目名&#125;     # 项目限制配额</span><br></pre></td></tr></table></figure>

<h2 id="虚拟机-「server」"><a href="#虚拟机-「server」" class="headerlink" title="虚拟机 「server」"></a>虚拟机 「server」</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">openstack console url show &#123;虚拟机名字&#125;</span><br><span class="line">openstack server delete &#123;虚拟机名字&#125;</span><br><span class="line">openstack server force-delete &#123;虚拟机名字&#125;       # 强制删除虚机</span><br><span class="line">openstack server list / show  </span><br><span class="line">openstack server resize      # 调整云主机大小</span><br><span class="line">openstack server event list --long &#123;虚拟机 id&#125;    # 查询云主机的事件</span><br></pre></td></tr></table></figure>

<h2 id="搁置-「shelve」"><a href="#搁置-「shelve」" class="headerlink" title="搁置 「shelve」"></a>搁置 「shelve」</h2><p>对于一些长时间不使用的虚拟机，即使处于关机状态，仍然会占用着集群资源<br>如果需要释放这些资源,则使用shelve来操作,该操作会将server实例作为image保存到glance中,然后在宿主机中删除该server实例</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">openstack server shelve &#123;虚机id&#125;  # 机器开启搁置状态 （搁置状态：--status SHELVED_OFFLOADED ）</span><br><span class="line">openstack server unshelve     # 取消搁置的机器</span><br></pre></td></tr></table></figure>

<h2 id="镜像-「image」"><a href="#镜像-「image」" class="headerlink" title="镜像 「image」"></a>镜像 「image」</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">共享私有镜像给其他项目</span><br><span class="line"></span><br><span class="line">openstack image set --shared &#123;镜像id&#125;    # 镜像设置为共享</span><br><span class="line">openstack image add project  &#123;镜像id&#125;  &#123;目标项目id&#125; </span><br><span class="line">openstack role add --user &#123;&#125;  project_member --project  &#123;目标项目id&#125; </span><br><span class="line"></span><br><span class="line">export OS_PROJECT_NAME=&#123;目标项目名&#125;       # 切换项目</span><br><span class="line">openstack image set --accept &#123;目标镜像id&#125; </span><br><span class="line">export OS_PROJECT_NAME=&#123;&#125;</span><br><span class="line">openstack role remove --user &#123;&#125; project_member --project &#123;目标项目id&#125;</span><br><span class="line"></span><br><span class="line">openstack image member list &#123;目标镜像id&#125;     # 验证是否共享成功</span><br><span class="line"></span><br><span class="line">openstack image set  # 更新镜像</span><br></pre></td></tr></table></figure>



<h2 id="网络-「network」"><a href="#网络-「network」" class="headerlink" title="网络 「network」"></a>网络 「network」</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">openstack floating ip list </span><br><span class="line"></span><br><span class="line">云主机添加无IP的网卡</span><br><span class="line">openstack network list --project &#123;项目名&#125;    # 查看项目下网络</span><br><span class="line"></span><br><span class="line">openstack port create  --network  &#123;网络id/name&#125;   &#123;端口名&#125;     在不指定IP地址的情况下创建一个端口</span><br><span class="line"></span><br><span class="line">创建指定IP地址的端口</span><br><span class="line">openstack port create --network net1 --fixed-ip subnet=subnet1,ip-address=192.0.2.40 &#123;端口名&#125;  </span><br><span class="line"></span><br><span class="line">openstack port list </span><br><span class="line">nova interface-attach --port-id  &#123;port id&#125;   &#123;server id&#125;   </span><br></pre></td></tr></table></figure>



<h2 id="支付者-「assignment」"><a href="#支付者-「assignment」" class="headerlink" title="支付者 「assignment」"></a>支付者 「assignment」</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">openstack role assignment list  --project  &#123;项目名&#125;  --name  # 查看用户的支付者</span><br></pre></td></tr></table></figure>



<h2 id="卷-「volume」"><a href="#卷-「volume」" class="headerlink" title="卷  「volume」"></a>卷  「volume」</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">openstack volume type list   # 查看卷类型</span><br><span class="line">openstack volume set --state &#123;&#125;     # 改变云硬盘状态  </span><br><span class="line">openstack volume backup list   # 查看云硬盘备份</span><br><span class="line">openstack volume snapshot list --all --volume &#123; id/name &#125;</span><br><span class="line"></span><br><span class="line">nova  volume-detach  &#123;云主机ID&#125; &#123;volume id&#125;     # 分离卷</span><br></pre></td></tr></table></figure>

<p>Volume 除了可以用作 instance 的数据盘，也可以作为启动盘（Bootable Volume）创建Volume时，选择Volume Source为image，创建后可以看到该volume是Bootable的，后可根据需求创建可启动volume</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">openstack volume create --image $IMAGE_ID --size $SIZE --type $TYPE --bootable $NAME</span><br></pre></td></tr></table></figure>



<h2 id="迁移-「migrate」"><a href="#迁移-「migrate」" class="headerlink" title="迁移  「migrate」"></a>迁移  「migrate」</h2><p>迁移的云主机若内存等资源使用率过高会导致热迁移实例写入内存页面的速度可能比复制它们的速度快<br>从而虚拟机产生了内存脏数据,无法完成迁移超时,虚拟机状态error</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">nova live-migration-force-complete 实例ID 迁移ID        # 强制迁移</span><br><span class="line">nova server-migration-list 实例ID                  # 获取迁移的任务ID</span><br><span class="line">nova live-migration-abort 实例ID 迁移ID                 # 取消迁移</span><br></pre></td></tr></table></figure>



<h2 id="负载均衡-「loadbalancer」"><a href="#负载均衡-「loadbalancer」" class="headerlink" title="负载均衡  「loadbalancer」"></a>负载均衡  「loadbalancer」</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">openstack loadbalancer list</span><br></pre></td></tr></table></figure>





<p><a href="https://access.redhat.com/documentation/zh-cn/red_hat_openstack_platform/17.0/html/command_line_interface_reference/index">redhat官方openstack命令行文档</a></p>
]]></content>
      <categories>
        <category>openstack</category>
      </categories>
  </entry>
</search>
